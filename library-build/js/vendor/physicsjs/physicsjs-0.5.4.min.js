/**
 * PhysicsJS v0.5.4 - 2014-02-03
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

!function(e,t){"object"==typeof exports?module.exports=t.call(e):"function"==typeof define&&define.amd?define([],function(){return t.call(e)}):e.Physics=t.call(e)}(this,function(){var e=this,t=e.document,n=function i(){return i.world.apply(i,arguments)};n.util={},!function(e){function r(e){return"function"!=typeof e.toString&&"string"==typeof (e+"")}function i(){}function s(e){e.length=0,L.length<M&&L.push(e)}function o(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);var r=-1;n=n-t||0;for(var i=Array(0>n?0:n);++r<n;)i[r]=e[t+r];return i}function u(){}function a(e,t,n,i,u){if(n){var f=n(e);if("undefined"!=typeof f)return f}if(!y(e))return e;var l=ft.call(e);if(!X[l]||!xt.nodeClass&&r(e))return e;var c=Et[l];switch(l){case F:case I:return new c(+e);case R:case W:return new c(e);case z:return f=c(e.source,_.exec(e)),f.lastIndex=e.lastIndex,f}if(l=Nt(e),t){var h=!i;i||(i=L.pop()||[]),u||(u=L.pop()||[]);for(var p=i.length;p--;)if(i[p]==e)return u[p];f=l?c(e.length):{}}else f=l?o(e):Ot({},e);return l&&(st.call(e,"index")&&(f.index=e.index),st.call(e,"input")&&(f.input=e.input)),t?(i.push(e),u.push(f),(l?At:_t)(e,function(e,r){f[r]=a(e,t,n,i,u)}),h&&(s(i),s(u)),f):f}function f(e,t,n){if("function"!=typeof e)return T;if("undefined"==typeof t)return e;var r=e.__bindData__||xt.funcNames&&!e.name;if("undefined"==typeof r){var i=P&&rt.call(e);xt.funcNames||!i||D.test(i)||(r=!0),(xt.funcNames||!r)&&(r=!xt.funcDecomp||P.test(i),Tt(e,r))}if(!0!==r&&r&&1&r[1])return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,s){return e.call(t,n,r,i,s)}}return S(e,t)}function l(e,t,n,i,o,u){if(n){var a=n(e,t);if("undefined"!=typeof a)return!!a}if(e===t)return 0!==e||1/e==1/t;if(e===e&&!(e&&K[typeof e]||t&&K[typeof t]))return!1;if(null==e||null==t)return e===t;var f=ft.call(e),c=ft.call(t);if(f==B&&(f=U),c==B&&(c=U),f!=c)return!1;switch(f){case F:case I:return+e==+t;case R:return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case z:case W:return e==t+""}if(c=f==j,!c){if(st.call(e,"__wrapped__")||st.call(t,"__wrapped__"))return l(e.__wrapped__||e,t.__wrapped__||t,n,i,o,u);if(f!=U||!xt.nodeClass&&(r(e)||r(t)))return!1;var f=!xt.argsObject&&m(e)?Object:e.constructor,h=!xt.argsObject&&m(t)?Object:t.constructor;if(f!=h&&!(g(f)&&f instanceof f&&g(h)&&h instanceof h))return!1}for(h=!o,o||(o=L.pop()||[]),u||(u=L.pop()||[]),f=o.length;f--;)if(o[f]==e)return u[f]==t;var p=0,a=!0;if(o.push(e),u.push(t),c){if(f=e.length,p=t.length,a=p==e.length,!a&&!i)return a;for(;p--;)if(c=f,h=t[p],i)for(;c--&&!(a=l(e[c],h,n,i,o,u)););else if(!(a=l(e[p],h,n,i,o,u)))break;return a}return Mt(t,function(t,r,s){return st.call(s,r)?(p++,a=st.call(e,r)&&l(e[r],t,n,i,o,u)):void 0}),a&&!i&&Mt(e,function(e,t,n){return st.call(n,t)?a=-1<--p:void 0}),h&&(s(o),s(u)),a}function h(e,t,n,r,i,s){var o=1&t,u=2&t,a=4&t,f=8&t,l=16&t,c=32&t,p=e;if(!u&&!g(e))throw new TypeError;l&&!n.length&&(t&=-17,l=n=!1),c&&!r.length&&(t&=-33,c=r=!1);var v=e&&e.__bindData__;if(v)return!o||1&v[1]||(v[4]=i),!o&&1&v[1]&&(t|=8),!a||4&v[1]||(v[5]=s),l&&ut.apply(v[2]||(v[2]=[]),n),c&&ut.apply(v[3]||(v[3]=[]),r),v[1]|=t,h.apply(null,v);if(!o||u||a||c||!(xt.fastBind||ht&&l))b=function(){var v=arguments,m=o?i:this;return(a||l||c)&&(v=bt.call(v),l&&lt.apply(v,n),c&&ut.apply(v,r),a&&v.length<s)?(t|=16,h(e,f?t:-4&t,v,null,i,s)):(u&&(e=m[p]),this instanceof b?(m=d(e.prototype),v=e.apply(m,v),y(v)?v:m):e.apply(m,v))};else{if(l){var m=[i];ut.apply(m,n)}var b=l?ht.apply(e,m):ht.call(e,i)}return Tt(b,bt.call(arguments)),b}function p(){J.h=H,J.b=J.c=J.g=J.i="",J.e="t",J.j=!0;for(var e,t=0;e=arguments[t];t++)for(var n in e)J[n]=e[n];t=J.a,J.d=/^[^,]+/.exec(t)[0],e=Function,t="return function("+t+"){",n=J;var r="var n,t="+n.d+",E="+n.e+";if(!t)return E;"+n.i+";";n.b?(r+="var u=t.length;n=-1;if("+n.b+"){",xt.unindexedChars&&(r+="if(s(t)){t=t.split('')}"),r+="while(++n<u){"+n.g+";}}else{"):xt.nonEnumArgs&&(r+="var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';"+n.g+";}}else{"),xt.enumPrototypes&&(r+="var G=typeof t=='function';"),xt.enumErrorProps&&(r+="var F=t===k||t instanceof Error;");var i=[];if(xt.enumPrototypes&&i.push('!(G&&n=="prototype")'),xt.enumErrorProps&&i.push('!(F&&(n=="message"||n=="name"))'),n.j&&n.f)r+="var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];",i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}";else if(r+="for(n in t){",n.j&&i.push("m.call(t, n)"),i.length&&(r+="if("+i.join("&&")+"){"),r+=n.g+";",i.length&&(r+="}"),r+="}",xt.nonEnumShadows){for(r+="if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];",k=0;7>k;k++)r+="n='"+n.h[k]+"';if((!(r&&x[n])&&m.call(t,n))",n.j||(r+="||(!x[n]&&t[n]!==A[n])"),r+="){"+n.g+"}";r+="}"}return(n.b||xt.nonEnumArgs)&&(r+="}"),r+=n.c+";return E",e("d,j,k,m,o,p,q,s,v,A,B,y,I,J,L",t+r+"}")(f,q,Y,st,O,m,Nt,w,J.f,Z,K,St,W,et,ft)}function d(e){return y(e)?pt(e):{}}function v(e){var t,n;return!e||ft.call(e)!=U||(t=e.constructor,g(t)&&!(t instanceof t))||!xt.argsClass&&m(e)||!xt.nodeClass&&r(e)?!1:xt.ownLast?(Mt(e,function(e,t,r){return n=st.call(r,t),!1}),!1!==n):(Mt(e,function(e,t){n=t}),"undefined"==typeof n||st.call(e,n))}function m(e){return e&&"object"==typeof e&&"number"==typeof e.length&&ft.call(e)==B||!1}function g(e){return"function"==typeof e}function y(e){return!!e&&!!K[typeof e]}function w(e){return"string"==typeof e||ft.call(e)==W}function E(e,t,n){if(t&&"undefined"==typeof n&&Nt(e)){n=-1;for(var r=e.length;++n<r&&!1!==t(e[n],n,e););}else At(e,t,n);return e}function S(e,t){return 2<arguments.length?h(e,17,bt.call(arguments,2),null,t):h(e,1,null,null,t)}function x(e,t,n){var r,i,s,o,u,a,f,l=0,c=!1,h=!0;if(!g(e))throw new TypeError;if(t=mt(0,t)||0,!0===n)var p=!0,h=!1;else y(n)&&(p=n.leading,c="maxWait"in n&&(mt(t,n.maxWait)||0),h="trailing"in n?n.trailing:h);var d=function(){var n=t-(ot()-o);n>0?a=setTimeout(d,n):(i&&clearTimeout(i),n=f,i=a=f=C,n&&(l=ot(),s=e.apply(u,r)))},v=function(){a&&clearTimeout(a),i=a=f=C,(h||c!==t)&&(l=ot(),s=e.apply(u,r))};return function(){if(r=arguments,o=ot(),u=this,f=h&&(a||!p),!1===c)var n=p&&!a;else{i||p||(l=o);var m=c-(o-l);m>0?i||(i=setTimeout(v,m)):(i&&(i=clearTimeout(i)),l=o,s=e.apply(u,r))}return a||t===c||(a=setTimeout(d,t)),n&&(s=e.apply(u,r)),s}}function T(e){return e}function N(e,t,n){var r=null==e,i=null==t;return null==n&&("boolean"==typeof e&&i?(n=e,e=1):i||"boolean"!=typeof t||(n=t,i=!0)),r&&i&&(t=1),e=+e||0,i?(t=e,e=0):t=+t||0,r=yt(),n||e%1||t%1?gt(e+r*(t-e+parseFloat("1e-"+((r+"").length-1))),t):e+nt(r*(t-e+1))}var C,L=[],A=0,O={},M=40,_=/\w*$/,D=/^function[ \n\r\t]+\w/,P=/\bthis\b/,H="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),B="[object Arguments]",j="[object Array]",F="[object Boolean]",I="[object Date]",q="[object Error]",R="[object Number]",U="[object Object]",z="[object RegExp]",W="[object String]",X={"[object Function]":!1};X[B]=X[j]=X[F]=X[I]=X[R]=X[U]=X[z]=X[W]=!0;var V={leading:!1,maxWait:0,trailing:!1},$={configurable:!1,enumerable:!1,value:null,writable:!1},J={a:"",b:null,c:"",d:"",e:"",v:null,g:"",h:null,support:null,i:"",j:!1},K={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},Q=K[typeof e]&&e||this,G=[],Y=Error.prototype,Z=Object.prototype,et=String.prototype,tt=RegExp("^"+(Z.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),nt=Math.floor,rt=Function.prototype.toString,it=tt.test(it=Object.getPrototypeOf)&&it,st=Z.hasOwnProperty,ot=tt.test(ot=Date.now)&&ot||function(){return+(new Date)},ut=G.push,at=Z.propertyIsEnumerable,ft=Z.toString,lt=G.unshift,ct=function(){try{var e={},t=tt.test(t=Object.defineProperty)&&t,n=t(e,e,e)&&t}catch(r){}return n}(),ht=tt.test(ht=ft.bind)&&ht,pt=tt.test(pt=Object.create)&&pt,dt=tt.test(dt=Array.isArray)&&dt,vt=tt.test(vt=Object.keys)&&vt,mt=Math.max,gt=Math.min,yt=Math.random,bt=G.slice;e=tt.test(Q.attachEvent);var wt=ht&&!/\n|true/.test(ht+e),Et={};Et[j]=Array,Et[F]=Boolean,Et[I]=Date,Et["[object Function]"]=Function,Et[U]=Object,Et[R]=Number,Et[z]=RegExp,Et[W]=String;var St={};St[j]=St[I]=St[R]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},St[F]=St[W]={constructor:!0,toString:!0,valueOf:!0},St[q]=St["[object Function]"]=St[z]={constructor:!0,toString:!0},St[U]={constructor:!0},function(){for(var e=H.length;e--;){var t,n=H[e];for(t in St)st.call(St,t)&&!st.call(St[t],n)&&(St[t][n]=!1)}}();var xt=u.support={};!function(){var e=function(){this.x=1},n={0:1,length:1},r=[];e.prototype={valueOf:1,y:1};for(var i in new e)r.push(i);for(i in arguments);xt.argsClass=ft.call(arguments)==B,xt.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),xt.enumErrorProps=at.call(Y,"message")||at.call(Y,"name"),xt.enumPrototypes=at.call(e,"prototype"),xt.fastBind=ht&&!wt,xt.funcDecomp=!tt.test(Q.WinRTError)&&P.test(function(){return this}),xt.funcNames="string"==typeof Function.name,xt.nonEnumArgs=0!=i,xt.nonEnumShadows=!/valueOf/.test(r),xt.ownLast="x"!=r[0],xt.spliceObjects=(G.splice.call(n,0,1),!n[0]),xt.unindexedChars="xx"!="x"[0]+Object("x")[0];try{xt.nodeClass=ft.call(t)!=U||!!({toString:0}+"")}catch(s){xt.nodeClass=!0}}(1),pt||(d=function(e){if(y(e)){i.prototype=e;var t=new i;i.prototype=null}return t||{}});var Tt=ct?function(e,t){$.value=t,ct(e,"__bindData__",$)}:i;xt.argsClass||(m=function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&st.call(e,"callee")||!1});var Nt=dt||function(e){return e&&"object"==typeof e&&"number"==typeof e.length&&ft.call(e)==j||!1},Ct=p({a:"z",e:"[]",i:"if(!(B[typeof z]))return E",g:"E.push(n)"}),kt=vt?function(e){return y(e)?xt.enumPrototypes&&"function"==typeof e||xt.nonEnumArgs&&e.length&&m(e)?Ct(e):vt(e):[]}:Ct,dt={a:"g,e,K",i:"e=e&&typeof K=='undefined'?e:d(e,K,3)",b:"typeof u=='number'",v:kt,g:"if(e(t[n],n,g)===false)return E"};e={a:"z,H,l",i:"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){",v:kt,g:"if(typeof E[n]=='undefined')E[n]=t[n]",c:"}}"};var Lt={i:"if(!B[typeof t])return E;"+dt.i,b:!1},At=p(dt),Ot=p(e,{i:e.i.replace(";",";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}"),g:"E[n]=e?e(E[n],t[n]):t[n]"}),Mt=p(dt,Lt,{j:!1}),_t=p(dt,Lt);g(/x/)&&(g=function(e){return"function"==typeof e&&"[object Function]"==ft.call(e)}),dt=it?function(e){if(!e||ft.call(e)!=U||!xt.argsClass&&m(e))return!1;var t=e.valueOf,n="function"==typeof t&&(n=it(t))&&it(n);return n?e==n||it(e)==n:v(e)}:v,u.assign=Ot,u.bind=S,u.createCallback=function(e,t,n){var r=typeof e;if(null==e||"function"==r)return f(e,t,n);if("object"!=r)return function(t){return t[e]};var i=kt(e),s=i[0],o=e[s];return 1!=i.length||o!==o||y(o)?function(t){for(var n=i.length,r=!1;n--&&(r=l(t[i[n]],e[i[n]],null,!0)););return r}:function(e){return e=e[s],o===e&&(0!==o||1/o==1/e)}},u.debounce=x,u.forEach=E,u.forIn=Mt,u.forOwn=_t,u.keys=kt,u.shuffle=function(e){var t=-1,n=e?e.length:0,r=Array("number"==typeof n?n:0);return E(e,function(e){var n=N(++t);r[t]=r[n],r[n]=e}),r},u.throttle=function(e,t,n){var r=!0,i=!0;if(!g(e))throw new TypeError;return!1===n?r=!1:y(n)&&(r="leading"in n?n.leading:r,i="trailing"in n?n.trailing:i),V.leading=r,V.maxWait=t,V.trailing=i,x(e,t,V)},u.each=E,u.extend=Ot,u.clone=function(e,t,n,r){return"boolean"!=typeof t&&null!=t&&(r=n,n=t,t=!1),a(e,t,"function"==typeof n&&f(n,r,1))},u.identity=T,u.isArguments=m,u.isArray=Nt,u.isFunction=g,u.isObject=y,u.isPlainObject=dt,u.isString=w,u.random=N,u.sortedIndex=function(e,t,n,r){var i=0,s=e?e.length:i;for(n=n?u.createCallback(n,r,1):T,t=n(t);s>i;)r=i+s>>>1,n(e[r])<t?i=r+1:s=r;return i},u.uniqueId=function(e){var t=++A;return(null==e?"":e)+""+t},u.VERSION="2.2.1",u.extend(n.util,u)}(this);var r=n.util.decorator=function(e,t){var r={},i={},s=function(e,t){return n.util.isFunction(t)?t:e},o=Object.getPrototypeOf;"function"!=typeof o&&(o="object"==typeof "test".__proto__?function(e){return e.__proto__}:function(e){return e.constructor.prototype});var u=Object.create;"function"!=typeof u&&(u=function(e){function t(){}return t.prototype=e,new t});var a=function(t,r){return"object"==typeof t?(i=n.util.extend(i,t,s),i.type=e,void 0):("type"!==t&&n.util.isFunction(r)&&(i[t]=r),void 0)};a(t);var f=function(t,a,f,l){var p,v=i;if("string"!=typeof a)l=f,f=a;else{if(v=r[a],!v)throw'Error: "'+a+'" '+e+" not defined";v=v.prototype}if("function"==typeof f)p=r[t],p?p.prototype=n.util.extend(p.prototype,f(o(p.prototype)),s):(p=r[t]=function(e){this.init&&this.init(e)},p.prototype=u(v),p.prototype=n.util.extend(p.prototype,f(v),s)),p.prototype.type=e,p.prototype.name=t;else if(l=f||{},p=r[t],!p)throw'Error: "'+t+'" '+e+" not defined";return l?new p(l):void 0};return f.mixin=a,f};return function(e){var t=e.Physics;n.noConflict=function(){return e.Physics===n&&(e.Physics=t),n}}(this),function(){var e=function t(e){return this instanceof t?(this.initPubsub(e),void 0):new t(e)};e.prototype={initPubsub:function(e){this._topics={},this._defaultScope=e||this},subscribe:function(e,t,r,i){var s,o=this._topics[e]||(this._topics[e]=[]),u=t;if(n.util.isObject(e)){for(var a in e)this.subscribe(a,e[a],t,r);return this}return n.util.isObject(r)?(t=n.util.bind(t,r),t._bindfn_=u):i||(i=r),t._priority_=i,s=n.util.sortedIndex(o,t,"_priority_"),o.splice(s,0,t),this},unsubscribe:function(e,t){if(e===!0)return this._topics={},this;var n,r=this._topics[e];if(!r)return this;if(t===!0)return this._topics[e]=[],this;for(var i=0,s=r.length;s>i;i++)if(n=r[i],n._bindfn_===t||n===t){r.splice(i,1);break}return this},publish:function(e){"object"!=typeof e&&(e={topic:e});var t=e.topic,n=this._topics[t],r=n&&n.length;if(!t)throw"Error: No topic specified in call to world.publish()";if(!r)return this;for(e.scope=e.scope||this._defaultScope;r--;)e.handler=n[r],e.handler(e);return this}},n.util.pubsub=e}(),function(e){for(var t=0,n=["ms","moz","webkit","o"],r=0;r<n.length&&!e.requestAnimationFrame;++r)e.requestAnimationFrame=e[n[r]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[n[r]+"CancelAnimationFrame"]||e[n[r]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(n){var r=(new Date).getTime(),i=Math.max(0,16-(r-t)),s=e.setTimeout(function(){n(r+i)},i);return t=r+i,s}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(e){clearTimeout(e)})}(this),function(){var e=100,t=10,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",s="Error: Too many scratchpads created. (Did you forget to call .done()?)",o=[],u=0,a=function(){if(this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[],++u>=e)throw s};a.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,o.push(this)},object:function(){var e=this.objectStack;if(!this._active)throw r;if(this.objIndex>=t)throw i;return e[this.objIndex++]||e[e.push({})-1]},array:function(){var e=this.arrayStack;if(!this._active)throw r;if(this.arrIndex>=t)throw i;return e[this.arrIndex++]||e[e.push([])-1]},vector:function(){var e=this.vectorStack;if(!this._active)throw r;if(this.vectorIndex>=t)throw i;return e[this.vectorIndex++]||e[e.push(n.vector())-1]},aabb:function(){var e=this.aabbStack;if(!this._active)throw r;if(this.aabbIndex>=t)throw i;return e[this.aabbIndex++]||e[e.push(n.aabb())-1]},transform:function(){var e=this.transformStack;if(!this._active)throw r;if(this.transformIndex>=t)throw i;return e[this.transformIndex++]||e[e.push(n.transform())-1]}},n.scratchpad=function(){var e=o.pop()||new a;return e._active=!0,e}}(),function(e){function t(n){var r=l;if(f){e.requestAnimationFrame(t);for(var i=0,s=r.length;s>i;++i)r[i](n,n-a);a=n}}function r(){return a=(new Date).getTime(),f=!0,t(),this}function i(){return f=!1,this}function s(e){if("function"==typeof e){for(var t=0,n=l.length;n>t;++t)if(e===l[t])return this;l.push(e)}return this}function o(e){for(var t=l,n=0,r=t.length;r>n;++n)if(t[n]===e)return t.splice(n,1),this;return this}function u(){return!!f}var a=0,f=!1,l=[];n.util.ticker={start:r,stop:i,subscribe:s,unsubscribe:o,isActive:u}}(this),function(){var e=function t(e,r,i,s){return this instanceof t?(this._pos=n.vector(),this.set(e,r,i,s),void 0):new t(e,r,i,s)};e.prototype.set=function(e,t,r,i){return n.util.isObject(e)?(this._pos.clone(e.pos),this._hw=e.halfWidth,this._hh=e.halfHeight,this):(this._pos.set(.5*(r+e),.5*(i+t)),this._hw=.5*(r-e),this._hh=.5*(i-t),this)},e.prototype.get=function(){var e=this.halfWidth(),t=this.halfHeight();return{pos:this._pos.values(),halfWidth:e,halfHeight:t,x:e,y:t}},e.prototype.halfWidth=function(){return this._hw},e.prototype.halfHeight=function(){return this._hh},e.prototype.contains=function(e){var t=void 0!==e.x?e.x:e.get(0),n=void 0!==e.y?e.y:e.get(1);return t>this._pos.get(0)-this._hw&&t<this._pos.get(0)+this._hw&&n>this._pos.get(1)-this._hh&&n<this._pos.get(1)+this._hh},e.prototype.transform=function(e){var t=this._hw,r=this._hh,i=n.scratchpad(),s=i.vector().set(t,r),o=i.vector().set(t,-r);return this._pos.translate(e),s.rotate(e),o.rotate(e),this._hw=Math.max(Math.abs(s.get(0)),Math.abs(o.get(0))),this._hh=Math.max(Math.abs(s.get(1)),Math.abs(o.get(1))),i.done(),this},e.contains=function(e,t){var n=void 0!==t.x?t.x:t.get(0),r=void 0!==t.y?t.y:t.get(1);return e=e.get?e.get():e,n>e.pos.x-e.halfWidth&&n<e.pos.x+e.halfWidth&&r>e.pos.y-e.halfHeight&&r<e.pos.y+e.halfHeight},n.aabb=e}(),function(){var e=1e-4,t=100,r=function(e,t,n){var r=t.normSq()-t.dot(e),i=t.dot(e)-e.normSq();return 0>r?n.clone(t).negate():i>0?n.clone(e).negate():(n.clone(t).vsub(e),n.perp(e.cross(n)<0))},i=function(e){var t,r,i=e.length,s=e[i-2],o=e[i-3],u=n.scratchpad(),a=u.vector().clone(s.pt),f=u.vector().clone(o.pt).vsub(a);if(f.equals(n.vector.zero))return u.done(),{a:s.a,b:s.b};if(t=-f.dot(a)/f.normSq(),r=1-t,0>=r)return u.done(),{a:o.a,b:o.b};if(0>=t)return u.done(),{a:s.a,b:s.b};var l={a:a.clone(s.a).mult(r).vadd(f.clone(o.a).mult(t)).values(),b:a.clone(s.b).mult(r).vadd(f.clone(o.b).mult(t)).values()};return u.done(),l},s=function(s,o,u,f){var l,h,p,v,m=!1,g=!1,y=!1,w=[],E=1,S=n.scratchpad(),x=S.vector().clone(o||n.vector.axis[0]),T=S.vector(),N=S.vector(),C=S.vector(),k=S.vector(),L=0;for(v=s(x),E=w.push(v),T.clone(v.pt),x.negate();++L;){if(T.swap(N),v=s(x),E=w.push(v),T.clone(v.pt),f&&f(w),T.equals(n.vector.zero)){m=!0;break}if(!g&&T.dot(x)<=0){if(u)break;g=!0}if(2===E)x=r(T,N,x);else if(g){if(x.normalize(),v=N.dot(x),Math.abs(v-T.dot(x))<e){y=-v;break}N.normSq()<C.clone(w[0].pt).normSq()?w.shift():w.splice(1,1),x=r(C.clone(w[1].pt),k.clone(w[0].pt),x)}else if(l=l||S.vector(),h=h||S.vector(),l.clone(N).vsub(T),h.clone(w[0].pt).vsub(T),p=l.cross(h)>0,p^T.cross(l)>0)w.shift(),l.perp(p),x.swap(l);else{if(!(p^h.cross(T)>0)){m=!0;break}w.splice(1,1),h.perp(!p),x.swap(l)}if(L>t)return S.done(),{simplex:w,iterations:L,distance:0,maxIterationsReached:!0}}return S.done(),v={overlap:m,simplex:w,iterations:L},y!==!1&&(v.distance=y,v.closest=i(w)),v};n.gjk=s}(),function(){var e=function t(e,r,i){return this instanceof t?(this.v=n.vector(),this.o=n.vector(),e instanceof t?(this.clone(e),void 0):(e&&this.setTranslation(e),this.setRotation(r||0,i),void 0)):new t(e,r)};e.prototype.setTranslation=function(e){return this.v.clone(e),this},e.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.cosA=t.cosA,this.sinA=t.sinA,this.o.clone(t.o),this):new e(this)},n.transform=e}(),function(e){var t=Math.sqrt,r=Math.min,i=Math.max,s=(Math.acos,Math.atan2),o=2*Math.PI,u=!!e.Float64Array,a=function f(e,t){return this instanceof f?(this._=u?new Float64Array(5):[],e&&(void 0!==e.x||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e||0,t||0)),void 0):new f(e,t)};a.prototype.set=function(e,t){return this.recalc=!0,this._[0]=e||0,this._[1]=t||0,this},a.prototype.get=function(e){return this._[e]},a.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},a.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},a.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=e,this._[1]+=void 0===t?e:t,this},a.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=void 0===t?e:t,this},a.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},a.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},a.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},a.prototype.proj=function(e){return this.dot(e)/e.norm()},a.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},a.prototype.angle=function(e){var t;if(this.equals(a.zero))return e?e.angle():0/0;for(t=e&&!e.equals(a.zero)?s(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):s(this._[1],this._[0]);t>Math.PI;)t-=o;for(;t<-Math.PI;)t+=o;return t},a.prototype.angle2=function(e,t){for(var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],u=t._[1]-this._[1],a=s(r*i-n*u,n*i+r*u);a>Math.PI;)a-=o;for(;a<-Math.PI;)a+=o;return a},a.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[3]},a.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[4]},a.prototype.dist=function(e){var n,r;return t((n=e._[0]-this._[0])*n+(r=e._[1]-this._[1])*r)},a.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},a.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=-this._[1],this._[1]=t):(this._[0]=this._[1],this._[1]=-t),this},a.prototype.normalize=function(){var e=this.norm();return 0===e?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},a.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},a.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},a.prototype.rotate=function(e,t){var n,r,i=0,s=0;return"number"==typeof e?(n=Math.sin(e),r=Math.cos(e),t&&(i=0|(t.x||t._[0]),s=0|(t.y||t._[1]))):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},a.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},a.prototype.translate=function(e){return this.vadd(e.v)},a.prototype.translateInv=function(e){return this.vsub(e.v)},a.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new a(this)},a.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},a.prototype.values=function(){return{x:this._[0],y:this._[1]}},a.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},a.prototype.negate=function(e){return void 0!==e?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},a.prototype.clamp=function(e,t){return e=e.values?e.values():e,t=t.values?t.values():t,this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},a.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},a.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},a.vadd=function(e,t){return new a(e._[0]+t._[0],e._[1]+t._[1])},a.vsub=function(e,t){return new a(e._[0]-t._[0],e._[1]-t._[1])},a.mult=function(e,t){return new a(t._[0]*e,t._[1]*e)},a.vproj=function(e,t){return a.mult(e.dot(t)/t.normSq(),t)},a.axis=[new a(1,0),new a(0,1)],a.zero=new a(0,0),n.vector=a}(this),function(){n.behavior=n.behaviour=r("behavior",{priority:0,init:function(){this.options={}},connect:function(e){this.behave&&e.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(e){this.behave&&e.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var e={fixed:!1,mass:1,restitution:1,cof:.8,view:null};n.body=r("body",{init:function(t){var r=n.vector;if(this.options=n.util.extend({},e,t),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:r(t.x,t.y),vel:r(t.vx,t.vy),acc:r(),angular:{pos:t.angle||0,vel:t.angularVelocity||0,acc:0},old:{pos:r(),vel:r(),acc:r(),angular:{pos:0,vel:0,acc:0}}},0===this.mass)throw"Error: Bodies must have non-zero mass";this.geometry=n.geometry("point")},accelerate:function(e){return this.state.acc.vadd(e),this},applyForce:function(e,t){var r,i=n.scratchpad(),s=i.vector();return t?this.moi&&(r=this.state,s.clone(t),this.state.angular.acc-=s.cross(e)/this.moi,this.applyForce(e)):this.accelerate(s.clone(e).mult(1/this.mass)),i.done(),this},aabb:function(){var e=n.scratchpad(),t=e.transform(),r=this.state.angular.pos,i=e.aabb().set(this.geometry.aabb(r));return t.setRotation(0).setTranslation(this.state.pos),i.transform(t),i=i.get(),e.done(),i},recalc:function(){}})}(),function(){n.geometry=r("geometry",{init:function(){this._aabb=new n.aabb},aabb:function(){return this._aabb.get()},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.set(0,0)},getFarthestCorePoint:function(e,t){return t=t||n.vector(),t.set(0,0)}})}(),n.geometry.isPolygonConvex=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=t.vector(),o=!0,u=!1,a=e.length;if(!e||!a)return!1;if(3>a)return t.done(),o;r.clone(e[0]).vsub(s.clone(e[a-1]));for(var f=1;a>=f;++f){if(i.clone(e[f%a]).vsub(s.clone(e[(f-1)%a])),u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return t.done(),o},n.geometry.getPolygonMOI=function(e){var t,r=n.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=0,a=e.length;if(2>a)return r.done(),0;if(2===a)return t=s.clone(e[1]).distSq(i.clone(e[0])),r.done(),t/12;i.clone(e[0]);for(var f=1;a>f;++f)s.clone(e[f]),t=Math.abs(s.cross(i)),o+=t*(s.normSq()+s.dot(i)+i.normSq()),u+=t,i.swap(s);return r.done(),o/(6*u)},n.geometry.isPointInPolygon=function(e,t){var r=n.scratchpad(),i=r.vector().clone(e),s=r.vector(),o=r.vector(),u=0,a=t.length;if(2>a)return u=i.equals(s.clone(t[0])),r.done(),u;if(2===a)return u=i.angle(s.clone(t[0])),u+=i.angle(s.clone(t[1])),r.done(),Math.abs(u)===Math.PI;s.clone(t[0]).vsub(i);for(var f=1;a>=f;++f)o.clone(t[f%a]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>1e-6},n.geometry.getPolygonArea=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=0,o=e.length;if(3>o)return t.done(),0;r.clone(e[o-1]);for(var u=0;o>u;++u)i.clone(e[u]),s+=r.cross(i),r.swap(i);return t.done(),s/2},n.geometry.getPolygonCentroid=function(e){var t,r=n.scratchpad(),i=r.vector(),s=r.vector(),o=n.vector(),u=e.length;if(2>u)return r.done(),n.vector(e[0]);if(2===u)return r.done(),n.vector((e[1].x+e[0].x)/2,(e[1].y+e[0].y)/2);i.clone(e[u-1]);for(var a=0;u>a;++a)s.clone(e[a]),t=i.cross(s),i.vadd(s).mult(t),o.vadd(i),i.swap(s);return t=1/(6*n.geometry.getPolygonArea(e)),r.done(),o.mult(t)},n.geometry.nearestPointOnLine=function(e,t,r){var i,s,o=n.scratchpad(),u=o.vector().clone(e),a=o.vector().clone(t).vsub(u),f=o.vector().clone(r).vsub(u).vsub(a);return f.equals(n.vector.zero)?(o.done(),n.vector(t)):(i=-f.dot(a)/f.normSq(),s=1-i,0>=s?(o.done(),n.vector(r)):0>=i?(o.done(),n.vector(t)):(u=n.vector(r).mult(i).vadd(a.clone(t).mult(s)),o.done(),u))},function(){var e={drag:0};n.integrator=r("integrator",{init:function(t){this.options=n.util.extend({},e,t)},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.publish({topic:"integrate:velocities",bodies:e,dt:t}),this.integratePositions(e,t),n&&n.publish({topic:"integrate:positions",bodies:e,dt:t}),this},integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var e={meta:!1,metaRefresh:200,width:600,height:600};n.renderer=r("renderer",{init:function(r){var i="string"==typeof r.el?t.getElementById(r.el):r.el;this.options=n.util.extend({},e,r),this.el=i?i:t.body,this.drawMeta=n.util.throttle(n.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(e,t){var n,r;this.beforeRender&&this.beforeRender(),this._world.publish({topic:"beforeRender",renderer:this,bodies:e,meta:t}),this.options.meta&&this.drawMeta(t);for(var i=0,s=e.length;s>i;++i)n=e[i],r=n.view||(n.view=this.createView(n.geometry)),n.hidden||this.drawBody(n,r);return this},createView:function(){throw"You must override the renderer.createView() method."},drawMeta:function(){throw"You must override the renderer.drawMeta() method."},drawBody:function(){throw"You must override the renderer.drawBody() method."}})}(),function(){var e=function(e){this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e)};n.util.each("body,behavior,integrator,renderer".split(","),function(t){n[t].mixin("setWorld",e)});var t=function s(e,t,n){for(var r,i,o=function(){return s(e,t,n)};r=e.shift();)if(i=r.apply(t,n),i&&i.then)return i.then(o)},r={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},i=function o(e,t){return this instanceof o?(this.init(e,t),void 0):new o(e,t)};i.prototype=n.util.extend({},n.util.pubsub.prototype,{init:function(e,r){(n.util.isFunction(e)||n.util.isArray(e))&&(r=e,e={}),this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this.initPubsub(this),this.options(e||{}),n.util.isFunction(r)?t([r],this,[this,n]):n.util.isArray(r)&&t(r,this,[this,n])},options:function(e){return e?(n.util.extend(this._opts,r,e),this.timeStep(this._opts.timestep),this.add(n.integrator(this._opts.integrator)),this):n.util.clone(this._opts)},add:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.addBehavior(r);break;case"integrator":this.integrator(r);break;case"renderer":this.renderer(r);break;case"body":this.addBody(r);break;default:throw'Error: failed to add item of unknown type "'+r.type+'" to world'}while(++t<n&&(r=e[t]));return this},remove:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.removeBehavior(r);break;case"integrator":r===this._integrator&&this.integrator(null);break;case"renderer":r===this._renderer&&this.renderer(null);break;case"body":this.removeBody(r);break;default:throw'Error: failed to remove item of unknown type "'+r.type+'" from world'}while(++t<n&&(r=e[t]));return this},has:function(e){var t,n,r;if(!e)return!1;switch(e.type){case"behavior":t=this._behaviors;break;case"integrator":return this._integrator===e;case"renderer":return this._renderer===e;case"body":t=this._bodies;break;default:throw'Error: unknown type "'+e.type+'"'}for(n=0,r=t.length;r>n;++n)if(e===t[n])return!0;return!1},integrator:function(e){var t;return void 0===e?this._integrator:this._integrator===e?this:(this._integrator&&(this._integrator.setWorld(null),t={topic:"remove:integrator",integrator:this._integrator},this.publish(t)),e&&(this._integrator=e,this._integrator.setWorld(this),t={topic:"add:integrator",integrator:this._integrator},this.publish(t)),this)},renderer:function(e){var t;return void 0===e?this._renderer:this._renderer===e?this:(this._renderer&&(this._renderer.setWorld(null),t={topic:"remove:renderer",renderer:this._renderer},this.publish(t)),e&&(this._renderer=e,this._renderer.setWorld(this),t={topic:"add:renderer",renderer:this._renderer},this.publish(t)),this)},timeStep:function(e){return e?(this._dt=e,this._maxJump=e*this._opts.maxIPF,this):this._dt},addBehavior:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._behaviors.push(e),t={topic:"add:behavior",behavior:e},this.publish(t),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t,n=this._behaviors;if(e)for(var r=0,i=n.length;i>r;++r)if(e===n[r]){n.splice(r,1),e.setWorld(null),t={topic:"remove:behavior",behavior:e},this.publish(t);break}return this},addBody:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._bodies.push(e),t={topic:"add:body",body:e},this.publish(t),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t,n=this._bodies;if(e)for(var r=0,i=n.length;i>r;++r)if(e===n[r]){n.splice(r,1),e.setWorld(null),t={topic:"remove:body",body:e},this.publish(t);break}return this},findOne:function(e){var t={check:function(e){for(var t=this;t=t.next;)if(t(e))return!0;return!1}},r=t,i=this._bodies;e.$within,e.$at&&(r.next=function(t){var r=t.aabb();return n.aabb.contains(r,e.$at)});for(var s=0,o=i.length;o>s;++s)if(t.check(i[s]))return i[s];return!1},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){if(this._paused)return this._time=!1,this;var t=this._time||(this._time=e),n=e-t,r=this._stats,i=this._dt;if(!n)return this;for(n>this._maxJump&&(this._time=e-this._maxJump,n=this._maxJump),r.fps=1e3/n,r.ipf=Math.ceil(n/this._dt);this._time<e;)this._time+=i,this.iterate(i);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,stats:this._stats,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),this.publish("destroy"),e.unsubscribe(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),n.world=i}(),n.integrator("verlet",function(e){return n.body.mixin({started:function(e){return void 0!==e&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){for(var n,r=t*t,i=1-this.options.drag,s=null,o=0,u=e.length;u>o;++o)s=e[o],n=s.state,s.fixed?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.vel.equals(n.old.vel)&&s.started()?n.vel.clone(n.pos).vsub(n.old.pos):(n.old.pos.clone(n.pos).vsub(n.vel),n.vel.mult(t)),i&&n.vel.mult(i),n.vel.vadd(n.acc.mult(r)),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.acc.zero(),n.angular.vel===n.old.angular.vel&&s.started()?n.angular.vel=n.angular.pos-n.old.angular.pos:(n.old.angular.pos=n.angular.pos-n.angular.vel,n.angular.vel*=t),n.angular.vel+=n.angular.acc*r,n.angular.vel/=t,n.old.angular.vel=n.angular.vel,n.angular.acc=0,s.started(!0))},integratePositions:function(e,t){for(var n,r=null,i=0,s=e.length;s>i;++i)r=e[i],n=r.state,r.fixed||(n.vel.mult(t),n.old.pos.clone(n.pos),n.pos.vadd(n.vel),n.vel.mult(1/t),n.old.vel.clone(n.vel),n.angular.vel*=t,n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel,n.angular.vel/=t,n.old.angular.vel=n.angular.vel)}}}),n.geometry("point",function(){}),n});